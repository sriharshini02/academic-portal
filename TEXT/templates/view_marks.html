<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Marks</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        min-height: 100vh;
        background: #1a1a1a;
        color: white;
      }

      .dashboard-container {
        display: grid;
        grid-template-columns: 250px 1fr;
        min-height: 100vh;
      }

      .main-content {
        padding: 2rem;
        background: #1e293b;
      }

      .filter-controls {
        background: #2d3748;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: flex-end;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
      }

      .filter-group label {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: #a0aec0;
      }

      .filter-group select,
      .filter-group input[type="text"] {
        padding: 0.75rem;
        border-radius: 4px;
        border: 1px solid #4a5568;
        background: #1a202c;
        color: white;
        font-size: 1rem;
      }

      .filter-group select:focus,
      .filter-group input[type="text"]:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.5);
      }

      .filter-group button {
        padding: 0.75rem 1.5rem;
        background: #8b5cf6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.3s ease;
      }

      .filter-group button:hover {
        background: #7c3aed;
      }

      .marks-table-container {
        background: #2d3748;
        padding: 1.5rem;
        border-radius: 8px;
        overflow-x: auto;
      }

      .marks-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        white-space: nowrap; /* Prevent wrapping of table content */
      }

      .marks-table th,
      .marks-table td {
        padding: 0.8rem 1rem;
        text-align: left;
        border-bottom: 1px solid #4a5568;
      }

      .marks-table th {
        background: #1a202c;
        color: #a0aec0;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
      }

      .marks-table td {
        color: #e2e8f0;
        font-size: 0.95rem;
      }

      .marks-table tbody tr:hover {
        background: #3a475a;
      }

      .marks-table input[type="number"] {
        width: 60px; /* Adjust width as needed */
        padding: 5px;
        background: #1a202c;
        border: 1px solid #4a5568;
        border-radius: 4px;
        color: white;
        text-align: center;
      }

      .marks-table .total-marks-display {
        background: none;
        border: none;
        font-weight: bold;
        color: #8b5cf6;
      }

      /* Actions column styling */
      .actions {
        display: flex;
        gap: 0.5rem;
      }

      .actions button {
        padding: 0.5rem 0.8rem;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.2s ease;
      }

      .edit-btn {
        background: #34d399; /* Green */
        color: white;
      }
      .edit-btn:hover {
        background: #10b981;
      }

      .save-btn {
        background: #60a5fa; /* Blue */
        color: white;
      }
      .save-btn:hover {
        background: #3b82f6;
      }

      .cancel-btn {
        background: #f87171; /* Red */
        color: white;
      }
      .cancel-btn:hover {
        background: #ef4444;
      }

      .delete-btn {
        background: #ef4444; /* Red */
        color: white;
      }
      .delete-btn:hover {
        background: #dc2626;
      }

      /* Row editing state */
      .marks-table tr.editing input[type="number"]:not(.total-marks-display) {
        pointer-events: auto; /* Enable input for editing */
        opacity: 1;
      }

      .marks-table
        tr:not(.editing)
        input[type="number"]:not(.total-marks-display) {
        pointer-events: none; /* Disable input when not editing */
        opacity: 0.8;
      }

      /* Initially hide save/cancel buttons */
      .marks-table .save-btn,
      .marks-table .cancel-btn {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      {% include 'sidebar.html' %}

      <main class="main-content">
        <h1>View Marks</h1>

        <div class="filter-controls">
          <div class="filter-group">
            <label for="classYearSelect">Class Year:</label>
            <select id="classYearSelect">
              <option value="">Select Year</option>
              {% for year in class_years %}
              <option value="{{ year }}">{{ year }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <label for="subjectSelect">Subject:</label>
            <select id="subjectSelect">
              <option value="">Select Subject</option>
              {% for subject_name in subjects %}
              <option value="{{ subject_name }}">{{ subject_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <label for="examTypeSelect">Exam Type:</label>
            <select id="examTypeSelect">
              <option value="">Select Exam</option>
              {% for exam_type_name in exam_types %}
              <option value="{{ exam_type_name }}">{{ exam_type_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <button onclick="viewMarks()">Apply Filters</button>
          </div>
        </div>

        <div class="marks-table-container">
          <div
            id="loadingMessage"
            style="display: none; text-align: center; color: #a0aec0"
          >
            Loading marks...
          </div>
          <table class="marks-table">
            <thead>
              <tr id="marksTableHeader">
                <th>Roll No</th>
                <!-- Dynamic question headers will be inserted here by JS -->
                <th>Total Marks</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="marksTableBody">
              <!-- Marks data will be loaded here by JavaScript -->
              <tr>
                <td colspan="9" style="text-align: center">
                  Select filters and click "Apply Filters" to view marks.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>

    <script>
      let currentClassYear = "";
      let currentSubject = "";
      let currentExamType = "";

      document.addEventListener("DOMContentLoaded", () => {
        // Set initial values from local storage if available, or defaults
        currentClassYear = localStorage.getItem("viewMarksClassYear") || "";
        currentSubject = localStorage.getItem("viewMarksSubject") || "";
        currentExamType = localStorage.getItem("viewMarksExamType") || "";

        document.getElementById("classYearSelect").value = currentClassYear;
        document.getElementById("subjectSelect").value = currentSubject;
        document.getElementById("examTypeSelect").value = currentExamType;

        // Automatically load marks if all filters are set from previous session
        if (currentClassYear && currentSubject && currentExamType) {
          viewMarks();
        }
      });

      function viewMarks() {
        currentClassYear = document.getElementById("classYearSelect").value;
        currentSubject = document.getElementById("subjectSelect").value;
        currentExamType = document.getElementById("examTypeSelect").value;

        // Save current selections to local storage
        localStorage.setItem("viewMarksClassYear", currentClassYear);
        localStorage.setItem("viewMarksSubject", currentSubject);
        localStorage.setItem("viewMarksExamType", currentExamType);

        const marksTableBody = document.getElementById("marksTableBody");
        const marksTableHeader = document.getElementById("marksTableHeader");
        const loadingMessage = document.getElementById("loadingMessage");

        marksTableBody.innerHTML = ""; // Clear existing data
        marksTableHeader.innerHTML =
          "<th>Roll No</th><th>Total Marks</th><th>Actions</th>"; // Reset header
        loadingMessage.style.display = "block"; // Show loading message

        if (!currentClassYear || !currentSubject || !currentExamType) {
          marksTableBody.innerHTML =
            '<tr><td colspan="20" style="text-align: center;">Please select all filters.</td></tr>';
          loadingMessage.style.display = "none";
          return;
        }

        fetch(
          `/api/get_marks?class_year=${currentClassYear}&subject=${currentSubject}&exam_type=${currentExamType}`
        )
          .then((response) => response.json())
          .then((data) => {
            loadingMessage.style.display = "none"; // Hide loading message
            if (data.success && data.results.length > 0) {
              // Dynamically build table headers
              marksTableHeader.innerHTML = ""; // Clear existing headers
              marksTableHeader.innerHTML += "<th>Roll No</th>";

              // Add question headers (Q1a, Q1b, etc.) including CO for each question
              if (data.results[0] && data.results[0].questions) {
                // Get sorted question keys (Q1, Q2, etc.)
                const qKeys = Object.keys(data.results[0].questions).sort(
                  (a, b) => {
                    return parseInt(a.substring(1)) - parseInt(b.substring(1));
                  }
                );

                qKeys.forEach((qKey) => {
                  marksTableHeader.innerHTML += `<th>${qKey}a</th><th>${qKey}b</th><th>${qKey}c</th><th>${qKey}d</th><th>${qKey} CO</th>`;
                });
              }

              marksTableHeader.innerHTML += "<th>Total Marks</th>";
              marksTableHeader.innerHTML += "<th>Actions</th>";

              data.results.forEach((result) => {
                let rowHtml = `
                    <tr data-roll="${result.roll_number}" data-result-id="${result.id}">
                        <td>${result.roll_number}</td>
                `;

                // Get sorted question keys for this student (Q1, Q2, etc.)
                const studentQKeys = Object.keys(result.questions).sort(
                  (a, b) => {
                    return parseInt(a.substring(1)) - parseInt(b.substring(1));
                  }
                );

                studentQKeys.forEach((qKey) => {
                  const qData = result.questions[qKey];
                  // Ensure marks are numbers, default to 0 if null/undefined
                  const part_a =
                    qData.a !== null && qData.a !== undefined ? qData.a : 0;
                  const part_b =
                    qData.b !== null && qData.b !== undefined ? qData.b : 0;
                  const part_c =
                    qData.c !== null && qData.c !== undefined ? qData.c : 0;
                  const part_d =
                    qData.d !== null && qData.d !== undefined ? qData.d : 0;
                  const co_value = qData.co || "N/A"; // Use 'N/A' if CO is not provided

                  rowHtml += `
                        <td><input type="number" value="${part_a}" min="0" max="5" step="0.1" class="q-mark" data-part="a" data-q="${qKey}" readonly></td>
                        <td><input type="number" value="${part_b}" min="0" max="5" step="0.1" class="q-mark" data-part="b" data-q="${qKey}" readonly></td>
                        <td><input type="number" value="${part_c}" min="0" max="5" step="0.1" class="q-mark" data-part="c" data-q="${qKey}" readonly></td>
                        <td><input type="number" value="${part_d}" min="0" max="5" step="0.1" class="q-mark" data-part="d" data-q="${qKey}" readonly></td>
                        <td><span class="co-display">${co_value}</span></td>
                    `;
                });

                rowHtml += `
                        <td><input type="number" value="${result.total_marks}" readonly class="total-marks-display"></td>
                        <td>
                            <div class="actions">
                                <button onclick="editRow(this)" class="edit-btn"><i class="fas fa-edit"></i> Edit</button>
                                <button onclick="saveEdit(this)" class="save-btn" style="display:none;"><i class="fas fa-save"></i> Save</button>
                                <button onclick="cancelEdit(this)" class="cancel-btn" style="display:none;"><i class="fas fa-times"></i> Cancel</button>
                                <button onclick="deleteRow(this)" class="delete-btn"><i class="fas fa-trash"></i> Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
                marksTableBody.innerHTML += rowHtml;
              });

              // Add event listeners for mark changes to update total
              marksTableBody.querySelectorAll(".q-mark").forEach((input) => {
                input.addEventListener("input", updateTotalMarks);
              });
            } else {
              marksTableBody.innerHTML =
                '<tr><td colspan="20" style="text-align: center;">No marks found for the selected filters.</td></tr>';
            }
          })
          .catch((error) => {
            loadingMessage.style.display = "none";
            console.error("Error fetching marks:", error);
            marksTableBody.innerHTML =
              '<tr><td colspan="20" style="text-align: center; color: #ef4444;">Error loading marks. Please try again.</td></tr>';
          });
      }

      function updateTotalMarks(event) {
        const row = event.target.closest("tr");
        let rowTotal = 0;
        row.querySelectorAll(".q-mark").forEach((input) => {
          rowTotal += parseFloat(input.value) || 0;
        });
        row.querySelector(".total-marks-display").value = rowTotal.toFixed(1); // Keep one decimal place
      }

      function editRow(btn) {
        const row = btn.closest("tr");
        row.classList.add("editing");
        row.querySelectorAll("input.q-mark").forEach((input) => {
          input.removeAttribute("readonly");
        });
        row.querySelector(".edit-btn").style.display = "none";
        row.querySelector(".save-btn").style.display = "inline-block";
        row.querySelector(".cancel-btn").style.display = "inline-block";
        row.querySelector(".delete-btn").style.display = "none";
      }

      function saveEdit(btn) {
        const row = btn.closest("tr");
        const resultId = row.dataset.resultId; // Get result ID
        const rollNumber = row.dataset.roll; // For delete method, if needed
        const totalMarks = parseFloat(
          row.querySelector(".total-marks-display").value
        );

        const questionData = {};
        row.querySelectorAll(".q-mark").forEach((input) => {
          const q = input.dataset.q;
          const part = input.dataset.part;
          if (!questionData[q]) {
            questionData[q] = {};
          }
          questionData[q][part] = parseFloat(input.value) || 0;
        });

        fetch("/api/update-marks", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            result_id: resultId, // Send result_id
            question_data: questionData,
            total_marks: totalMarks, // This is now redundant if updated on backend, but ok to send.
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Marks updated successfully!");
              row.classList.remove("editing");
              row.querySelectorAll("input.q-mark").forEach((input) => {
                input.setAttribute("readonly", true);
              });
              row.querySelector(".edit-btn").style.display = "inline-block";
              row.querySelector(".save-btn").style.display = "none";
              row.querySelector(".cancel-btn").style.display = "none";
              row.querySelector(".delete-btn").style.display = "inline-block";
              // Re-fetch to update total marks and COs after save
              viewMarks();
            } else {
              alert(data.message || "Failed to update marks");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error updating marks");
          });
      }

      function cancelEdit(btn) {
        const row = btn.closest("tr");
        row.classList.remove("editing");
        row.querySelectorAll("input.q-mark").forEach((input) => {
          input.setAttribute("readonly", true);
        });
        row.querySelector(".edit-btn").style.display = "inline-block";
        row.querySelector(".save-btn").style.display = "none";
        row.querySelector(".cancel-btn").style.display = "none";
        row.querySelector(".delete-btn").style.display = "inline-block";

        // Re-fetch the data to revert any unsaved changes
        viewMarks();
      }

      function deleteRow(btn) {
        if (!confirm("Are you sure you want to delete this result?")) {
          return;
        }

        const row = btn.closest("tr");
        const rollNumber = row.dataset.roll;

        fetch("/api/delete-marks", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            roll_number: rollNumber,
            class_year: currentClassYear,
            subject: currentSubject,
            exam_type: currentExamType,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              row.remove();
              alert("Result deleted successfully!");
            } else {
              alert(data.message || "Failed to delete result");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error deleting result");
          });
      }
    </script>
  </body>
</html>

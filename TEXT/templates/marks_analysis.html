<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marks Analysis</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        min-height: 100vh;
        background: #1a1a1a;
        color: white;
      }

      .dashboard-container {
        display: grid;
        grid-template-columns: 250px 1fr;
        min-height: 100vh;
      }

      .sidebar {
        background: #8b5cf6;
        color: white;
        padding: 1.5rem;
        min-height: 100vh;
      }

      .main-content {
        padding: 2rem;
        background: #1e293b;
      }

      h1 {
        color: #8b5cf6;
        margin-bottom: 1.5rem;
        text-align: center;
      }

      .filter-controls {
        background: #2d3748;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: flex-end;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
      }

      .filter-group label {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: #a0aec0;
      }

      .filter-group select,
      .filter-group input[type="text"] {
        padding: 0.75rem;
        border-radius: 4px;
        border: 1px solid #4a5568;
        background: #1a202c;
        color: white;
        font-size: 1rem;
      }

      .filter-group select:focus,
      .filter-group input[type="text"]:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.5);
      }

      .filter-group button {
        padding: 0.75rem 1.5rem;
        background: #8b5cf6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.3s ease;
      }

      .filter-group button:hover {
        background: #7c3aed;
      }

      .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .chart-container,
      .list-container {
        background: #2d3748;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .chart-container h3,
      .list-container h3 {
        color: #8b5cf6;
        margin-bottom: 1rem;
        text-align: center;
      }

      .chart-container canvas {
        max-height: 350px; /* Limit chart height */
        width: 100% !important; /* Override Chart.js default inline width */
        height: 100% !important; /* Override Chart.js default inline height */
      }

      .list-container ul {
        list-style: none;
        padding: 0;
      }

      .list-container .student-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #4a5568;
      }

      .list-container .student-item:last-child {
        border-bottom: none;
      }

      .student-rank {
        font-weight: 600;
        color: #34d399; /* Green for rank */
        margin-right: 0.5rem;
      }

      .student-marks {
        font-weight: 500;
        color: #60a5fa; /* Blue for marks */
      }

      .no-data {
        text-align: center;
        padding: 2rem;
        color: #a0aec0;
      }

      #loadingMessage {
        text-align: center;
        padding: 1rem;
        color: #a0aec0;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      {% include 'sidebar.html' %}

      <main class="main-content">
        <h1>Marks Analysis</h1>

        <div class="filter-controls">
          <div class="filter-group">
            <label for="classYearSelect">Class Year:</label>
            <select id="classYearSelect">
              <option value="">Select Year</option>
              {% for year in class_years %}
              <option value="{{ year }}">{{ year }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <label for="subjectSelect">Subject:</label>
            <select id="subjectSelect">
              <option value="">Select Subject</option>
              {% for subject_name in subjects %}
              <option value="{{ subject_name }}">{{ subject_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <label for="examTypeSelect">Exam Type:</label>
            <select id="examTypeSelect">
              <option value="">Select Exam</option>
              {% for exam_type_name in exam_types %}
              <option value="{{ exam_type_name }}">{{ exam_type_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <button onclick="fetchAnalysis()">Apply Filters</button>
          </div>
        </div>

        <div id="loadingMessage" style="display: none">Loading analysis...</div>
        <div id="noDataMessage" class="no-data" style="display: none">
          No analysis data available for the selected filters.
        </div>

        <div class="chart-grid">
          <div class="chart-container">
            <h3>Overall Class Average</h3>
            <canvas id="averageOverallChart"></canvas>
          </div>

          <div class="chart-container">
            <h3>Question-wise Performance</h3>
            <canvas id="questionAnalysisChart"></canvas>
          </div>

          <!-- NEW: Course Outcome Performance Chart -->
          <div class="chart-container">
            <h3>Performance by Course Outcome</h3>
            <canvas id="coPerformanceChart"></canvas>
          </div>

          <div class="list-container">
            <h3>Top Performers</h3>
            <ul id="topPerformersList">
              <li>No data</li>
            </ul>
          </div>

          <div class="list-container">
            <h3>Needs Improvement</h3>
            <ul id="needsImprovementList">
              <li>No data</li>
            </ul>
          </div>
        </div>
      </main>
    </div>

    <script>
      let charts = {}; // Object to hold chart instances

      // Function to initialize all chart instances once
      function initializeCharts() {
        // Overall Average Chart
        const avgCtx = document.getElementById("averageOverallChart");
        if (avgCtx) {
          charts.averageOverallChart = new Chart(avgCtx, {
            type: "bar",
            data: {
              labels: ["Class Average"],
              datasets: [
                {
                  label: "Average Marks",
                  data: [0], // Placeholder
                  backgroundColor: "rgba(139, 92, 246, 0.7)",
                  borderColor: "rgba(139, 92, 246, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100, // Assuming marks out of 100
                  title: {
                    display: true,
                    text: "Marks (%)",
                    color: "rgba(255, 255, 255, 0.9)",
                  },
                  ticks: { color: "rgba(255, 255, 255, 0.7)" },
                  grid: { color: "rgba(255, 255, 255, 0.1)" },
                },
                x: {
                  ticks: { color: "rgba(255, 255, 255, 0.7)" },
                  grid: { color: "rgba(255, 255, 255, 0.1)" },
                },
              },
              plugins: {
                legend: {
                  display: false,
                },
                title: {
                  display: true,
                  text: "Class Performance",
                  color: "rgba(255, 255, 255, 0.9)",
                },
              },
            },
          });
        }

        // Question Analysis Chart
        const qCtx = document.getElementById("questionAnalysisChart");
        if (qCtx) {
          charts.questionAnalysisChart = new Chart(qCtx, {
            type: "line",
            data: {
              labels: [], // Q1, Q2, etc.
              datasets: [
                {
                  label: "Part a",
                  data: [],
                  borderColor: "rgba(255, 99, 132, 1)",
                  backgroundColor: "rgba(255, 99, 132, 0.2)",
                  tension: 0.3,
                },
                {
                  label: "Part b",
                  data: [],
                  borderColor: "rgba(54, 162, 235, 1)",
                  backgroundColor: "rgba(54, 162, 235, 0.2)",
                  tension: 0.3,
                },
                {
                  label: "Part c",
                  data: [],
                  borderColor: "rgba(75, 192, 192, 1)",
                  backgroundColor: "rgba(75, 192, 192, 0.2)",
                  tension: 0.3,
                },
                {
                  label: "Part d",
                  data: [],
                  borderColor: "rgba(153, 102, 255, 1)",
                  backgroundColor: "rgba(153, 102, 255, 0.2)",
                  tension: 0.3,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 5, // Assuming marks are out of 5 for each part
                  title: {
                    display: true,
                    text: "Average Marks",
                    color: "rgba(255, 255, 255, 0.9)",
                  },
                  ticks: { color: "rgba(255, 255, 255, 0.7)" },
                  grid: { color: "rgba(255, 255, 255, 0.1)" },
                },
                x: {
                  ticks: { color: "rgba(255, 255, 255, 0.7)" },
                  grid: { color: "rgba(255, 255, 255, 0.1)" },
                },
              },
              plugins: {
                legend: {
                  labels: {
                    color: "rgba(255, 255, 255, 0.7)",
                  },
                },
                title: {
                  display: true,
                  text: "Question-wise Average Marks",
                  color: "rgba(255, 255, 255, 0.9)",
                },
              },
            },
          });
        }

        // NEW: CO Performance Chart
        const coCtx = document.getElementById("coPerformanceChart");
        if (coCtx) {
          charts.coPerformanceChart = new Chart(coCtx, {
            type: "bar",
            data: {
              labels: [], // e.g., ['CO1', 'CO2', 'CO3']
              datasets: [
                {
                  label: "Average Attainment (%)",
                  data: [],
                  backgroundColor: [
                    "rgba(139, 92, 246, 0.7)", // Purple
                    "rgba(34, 197, 94, 0.7)", // Green
                    "rgba(251, 191, 36, 0.7)", // Yellow
                    "rgba(239, 68, 68, 0.7)", // Red
                    "rgba(59, 130, 246, 0.7)", // Blue
                  ],
                  borderColor: [
                    "rgba(139, 92, 246, 1)",
                    "rgba(34, 197, 94, 1)",
                    "rgba(251, 191, 36, 1)",
                    "rgba(239, 68, 68, 1)",
                    "rgba(59, 130, 246, 1)",
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100, // Percentage
                  title: {
                    display: true,
                    text: "Attainment Percentage (%)",
                    color: "rgba(255, 255, 255, 0.9)",
                  },
                  ticks: { color: "rgba(255, 255, 255, 0.7)" },
                  grid: { color: "rgba(255, 255, 255, 0.1)" },
                },
                x: {
                  ticks: { color: "rgba(255, 255, 255, 0.7)" },
                  grid: { color: "rgba(255, 255, 255, 0.1)" },
                },
              },
              plugins: {
                legend: {
                  display: false,
                },
                title: {
                  display: true,
                  text: "Overall Course Outcome Performance",
                  color: "rgba(255, 255, 255, 0.9)",
                },
              },
            },
          });
        }
      }

      // Function to update chart data with fetched data
      function updateCharts(data) {
        // Update Overall Average Chart
        if (charts.averageOverallChart) {
          charts.averageOverallChart.data.datasets[0].data = [
            data.average_overall,
          ];
          charts.averageOverallChart.update();
        }

        // Update Question Analysis Chart
        if (charts.questionAnalysisChart && data.question_analysis) {
          const questionLabels = data.question_analysis.map((q) => q.question);
          const partA = data.question_analysis.map((q) => q.average_marks.a);
          const partB = data.question_analysis.map((q) => q.average_marks.b);
          const partC = data.question_analysis.map((q) => q.average_marks.c);
          const partD = data.question_analysis.map((q) => q.average_marks.d);

          charts.questionAnalysisChart.data.labels = questionLabels;
          charts.questionAnalysisChart.data.datasets[0].data = partA;
          charts.questionAnalysisChart.data.datasets[1].data = partB;
          charts.questionAnalysisChart.data.datasets[2].data = partC;
          charts.questionAnalysisChart.data.datasets[3].data = partD;
          charts.questionAnalysisChart.update();
        }

        // NEW: Update CO Performance Chart
        if (charts.coPerformanceChart && data.co_performance) {
          const coLabels = Object.keys(data.co_performance).sort(); // Sort COs for consistent display
          const coAverages = coLabels.map((co) => data.co_performance[co]);
          charts.coPerformanceChart.data.labels = coLabels;
          charts.coPerformanceChart.data.datasets[0].data = coAverages;
          charts.coPerformanceChart.update();
        }
      }

      function updateLists(data) {
        // Update Top Performers List
        const topPerformersList = document.getElementById("topPerformersList");
        if (data.top_performers && data.top_performers.length > 0) {
          const topPerformersHtml = data.top_performers
            .map(
              (student, index) => `
                        <div class="student-item">
                            <span><span class="student-rank">#${
                              index + 1
                            }</span> ${student.roll_number}</span>
                            <span class="student-marks">${student.marks}%</span>
                        </div>
                    `
            )
            .join("");
          topPerformersList.innerHTML = topPerformersHtml;
        } else {
          topPerformersList.innerHTML = "<li>No data</li>";
        }

        // Update Needs Improvement List
        const needsImprovementList = document.getElementById(
          "needsImprovementList"
        );
        if (data.needs_improvement && data.needs_improvement.length > 0) {
          const needsImprovementHtml = data.needs_improvement
            .map(
              (student, index) => `
                        <div class="student-item">
                            <span><span class="student-rank">#${
                              index + 1
                            }</span> ${student.roll_number}</span>
                            <span class="student-marks">${student.marks}%</span>
                        </div>
                    `
            )
            .join("");
          needsImprovementList.innerHTML = needsImprovementHtml;
        } else {
          needsImprovementList.innerHTML = "<li>No data</li>";
        }
      }

      async function fetchAnalysis() {
        const classYear = document.getElementById("classYearSelect").value;
        const subject = document.getElementById("subjectSelect").value;
        const examType = document.getElementById("examTypeSelect").value;

        const loadingMessage = document.getElementById("loadingMessage");
        const noDataMessage = document.getElementById("noDataMessage");
        const chartGrid = document.querySelector(".chart-grid");

        loadingMessage.style.display = "block";
        noDataMessage.style.display = "none";
        chartGrid.style.display = "none"; // Hide charts during loading

        if (!classYear || !subject || !examType) {
          loadingMessage.style.display = "none";
          noDataMessage.textContent =
            "Please select all filters to view analysis.";
          noDataMessage.style.display = "block";
          return;
        }

        try {
          const response = await fetch(
            `/get_analysis?class_year=${classYear}&subject=${subject}&exam_type=${examType}`
          );
          const result = await response.json();

          loadingMessage.style.display = "none";

          if (
            result.success &&
            result.data &&
            (Object.keys(result.data.co_performance).length > 0 ||
              result.data.average_overall > 0 ||
              result.data.question_analysis.length > 0 ||
              result.data.top_performers.length > 0)
          ) {
            updateCharts(result.data); // Pass only the 'data' object
            updateLists(result.data); // Pass only the 'data' object
            chartGrid.style.display = "grid"; // Show charts after data is loaded
          } else {
            noDataMessage.textContent =
              result.message ||
              "No analysis data available for the selected filters.";
            noDataMessage.style.display = "block";
            // Clear existing charts/lists if no data is found for new filters
            updateCharts({
              average_overall: 0,
              question_analysis: [],
              co_performance: {},
            });
            updateLists({ top_performers: [], needs_improvement: [] });
          }
        } catch (error) {
          loadingMessage.style.display = "none";
          noDataMessage.textContent =
            "Error loading analysis data. Please try again.";
          noDataMessage.style.display = "block";
          console.error("Error fetching analysis:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        initializeCharts();
        // Optionally, pre-fill filters from localStorage and fetch data on load
        const storedClassYear = localStorage.getItem(
          "selectedMarksAnalysisClassYear"
        );
        const storedSubject = localStorage.getItem(
          "selectedMarksAnalysisSubject"
        );
        const storedExamType = localStorage.getItem(
          "selectedMarksAnalysisExamType"
        );

        if (storedClassYear)
          document.getElementById("classYearSelect").value = storedClassYear;
        if (storedSubject)
          document.getElementById("subjectSelect").value = storedSubject;
        if (storedExamType)
          document.getElementById("examTypeSelect").value = storedExamType;

        if (storedClassYear && storedSubject && storedExamType) {
          fetchAnalysis();
        }
      });

      // Save filter selections to localStorage when changed
      document
        .getElementById("classYearSelect")
        .addEventListener("change", (e) =>
          localStorage.setItem("selectedMarksAnalysisClassYear", e.target.value)
        );
      document
        .getElementById("subjectSelect")
        .addEventListener("change", (e) =>
          localStorage.setItem("selectedMarksAnalysisSubject", e.target.value)
        );
      document
        .getElementById("examTypeSelect")
        .addEventListener("change", (e) =>
          localStorage.setItem("selectedMarksAnalysisExamType", e.target.value)
        );
    </script>
  </body>
</html>
